#!/bin/sh

### BEGIN INIT INFO
# Provides:          u8g2_hw_i2c_dvd
# Required-Start:    $local_fs $syslog
# Required-Stop:     $local_fs $syslog
# Default-Start:     S
# Default-Stop:      0 6
# Short-Description: Start u8g2_hw_i2c_dvd app
### END INIT INFO

APP_PATH="/app/u8g2_hw_i2c_dvd"
APP_NAME="u8g2_hw_i2c_dvd"

WATCHDOG_PID="/var/run/${APP_NAME}_watchdog.pid"
APP_PID="/var/run/${APP_NAME}.pid"
LOG_FILE="/var/log/${APP_NAME}.log"

start() {
    echo "Starting ${APP_NAME}..."

    if [ -f "$WATCHDOG_PID" ] && kill -0 $(cat "$WATCHDOG_PID") 2>/dev/null; then
        echo "${APP_NAME} already running."
        return 0
    fi

    (
        while true; do
            echo "$(date '+%F %T') start ${APP_NAME}" >> "$LOG_FILE"

            $APP_PATH >> "$LOG_FILE" 2>&1 &
            echo $! > "$APP_PID"

            wait $!

            echo "$(date '+%F %T') ${APP_NAME} crashed, restart after 2s" >> "$LOG_FILE"
            sleep 2
        done
    ) &

    echo $! > "$WATCHDOG_PID"
    echo "${APP_NAME} watchdog started."
}

stop() {
    echo "Stopping ${APP_NAME}..."

    if [ -f "$WATCHDOG_PID" ]; then
        kill $(cat "$WATCHDOG_PID") 2>/dev/null
        rm -f "$WATCHDOG_PID"
    fi

    if [ -f "$APP_PID" ]; then
        kill $(cat "$APP_PID") 2>/dev/null
        rm -f "$APP_PID"
    fi

    echo "${APP_NAME} stopped."
}

restart() {
    stop
    sleep 1
    start
}

status() {
    if [ -f "$APP_PID" ] && kill -0 $(cat "$APP_PID") 2>/dev/null; then
        echo "${APP_NAME} is running (pid $(cat $APP_PID))"
    else
        echo "${APP_NAME} is not running"
    fi
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

exit 0

