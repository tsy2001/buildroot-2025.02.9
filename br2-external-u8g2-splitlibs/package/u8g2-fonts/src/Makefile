\
# Build wrapper for selected u8g2 fonts into libu8g2font.so
#
# Put font C files into $(FONT_DIR). Each file usually defines one
# symbol like: const uint8_t u8g2_font_xxx[] = {...};
#
# These files are often generated by bdfconv.

PREFIX ?= /usr
DESTDIR ?=
FONT_DIR ?= ../fonts

LIBNAME := u8g2font
SONAME  := lib$(LIBNAME).so.1
REALSO  := lib$(LIBNAME).so.1.0.0

CC     ?= gcc
AR     ?= ar
RANLIB ?= ranlib
STRIP  ?= strip

CFLAGS   ?= -O2
CPPFLAGS ?=
LDFLAGS  ?=

CFLAGS   += -fPIC -std=c99 -D__ARM_LINUX__
# Fonts usually include u8g2.h; Buildroot installs headers into staging:
CPPFLAGS += -I$(DESTDIR)$(PREFIX)/include/u8g2
# But when invoked by Buildroot, DESTDIR is STAGING_DIR or TARGET_DIR,
# and PREFIX is /usr, so include path becomes:
#   $(STAGING_DIR)/usr/include/u8g2

SRCS := $(wildcard $(FONT_DIR)/*.c)
OBJS := $(patsubst $(FONT_DIR)/%.c,build/%.o,$(SRCS))

.PHONY: all clean install-staging install-target

all: $(REALSO) symlinks

build:
	mkdir -p build

build/%.o: $(FONT_DIR)/%.c | build
	$(CC) $(CPPFLAGS) $(CFLAGS) -c $< -o $@

$(REALSO): $(OBJS)
	$(CC) -shared -Wl,-soname,$(SONAME) $(LDFLAGS) -o $@ $^

symlinks:
	ln -sf $(REALSO) $(SONAME)
	ln -sf $(SONAME) lib$(LIBNAME).so

install-staging: all
	install -d $(DESTDIR)$(PREFIX)/lib
	install -m 0755 $(REALSO) $(DESTDIR)$(PREFIX)/lib/
	ln -sf $(REALSO) $(DESTDIR)$(PREFIX)/lib/$(SONAME)
	ln -sf $(SONAME) $(DESTDIR)$(PREFIX)/lib/lib$(LIBNAME).so
	install -d $(DESTDIR)$(PREFIX)/lib/pkgconfig
	sed -e 's|@PREFIX@|$(PREFIX)|g' -e 's|@VERSION@|1.0|g' u8g2font.pc.in > $(DESTDIR)$(PREFIX)/lib/pkgconfig/u8g2font.pc

install-target: all
	install -d $(DESTDIR)$(PREFIX)/lib
	install -m 0755 $(REALSO) $(DESTDIR)$(PREFIX)/lib/
	ln -sf $(REALSO) $(DESTDIR)$(PREFIX)/lib/$(SONAME)
	ln -sf $(SONAME) $(DESTDIR)$(PREFIX)/lib/lib$(LIBNAME).so

clean:
	rm -rf build lib$(LIBNAME).so*
